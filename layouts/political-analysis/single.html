{{ define "main" }}
<link href="https://cdn.jsdelivr.net/npm/daisyui@5.0.0/dist/full.min.css" rel="stylesheet" type="text/css" />
<script src="https://cdn.tailwindcss.com"></script>

<div class="container mx-auto px-4 py-8 max-w-6xl">
  
  <!-- Header Section -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold mb-4 text-gray-900">Political Objectivity Tester</h1>
    <p class="text-lg text-gray-700">Analyze social media posts for factuality, political bias, and evidence quality</p>
  </div>

  <!-- Input Section -->
  <div class="card bg-base-200 shadow-xl mb-8">
    <div class="card-body">
      <h2 class="card-title text-2xl mb-4">Enter Post to Analyze</h2>
      
      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text">Social Media Post</span>
        </label>
        <textarea 
          id="postInput" 
          class="textarea textarea-bordered h-32" 
          placeholder="Paste the social media post you want to analyze here..."
        ></textarea>
      </div>

      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text">AI API Key (Anthropic, OpenAI, etc.)</span>
        </label>
        <input 
          type="password" 
          id="apiKey" 
          class="input input-bordered" 
          placeholder="Your API key (never stored or logged)"
        />
        <label class="label">
          <span class="label-text-alt">Your API key is used only for this analysis and is never stored</span>
        </label>
      </div>

      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text">AI Provider</span>
        </label>
        <select id="apiProvider" class="select select-bordered">
          <option value="anthropic">Anthropic (Claude)</option>
          <option value="openai">OpenAI (GPT)</option>
        </select>
      </div>

      <button 
        id="analyzeBtn" 
        class="btn btn-primary btn-lg w-full"
        onclick="analyzePost()"
      >
        Analyze Post
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="alert alert-info mb-8 hidden">
    <span class="loading loading-spinner"></span>
    <span>Analyzing post and fact-checking claims...</span>
  </div>

  <!-- Error State -->
  <div id="errorState" class="alert alert-error mb-8 hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span id="errorMessage"></span>
  </div>

  <!-- Results Section -->
  <div id="resultsSection" class="hidden">
    
    <!-- Visual Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      
      <!-- Factuality Score -->
      <div class="card bg-base-200 shadow-xl">
        <div class="card-body items-center text-center">
          <h3 class="card-title text-xl mb-4">Factuality Score</h3>
          <div class="radial-progress" id="factualityProgress" style="--value:0; --size:12rem; --thickness: 1rem;">
            <span class="text-3xl font-bold" id="factualityValue">0%</span>
          </div>
          <p class="mt-4 text-sm" id="factualityLabel">Analyzing...</p>
        </div>
      </div>

      <!-- Political Lean -->
      <div class="card bg-base-200 shadow-xl">
        <div class="card-body">
          <h3 class="card-title text-xl mb-4 text-center">Political Lean</h3>
          <div class="flex flex-col gap-2">
            <div class="flex justify-between text-xs">
              <span>Left</span>
              <span>Center</span>
              <span>Right</span>
            </div>
            <progress id="politicalProgress" class="progress progress-primary" value="50" max="100"></progress>
            <p class="text-center text-sm mt-2" id="politicalLabel">Neutral</p>
          </div>
        </div>
      </div>

      <!-- Evidence Type -->
      <div class="card bg-base-200 shadow-xl">
        <div class="card-body">
          <h3 class="card-title text-xl mb-4 text-center">Evidence Type</h3>
          <div class="flex flex-col gap-2">
            <div class="flex justify-between text-xs">
              <span>Fact-Based</span>
              <span>Mixed</span>
              <span>Opinion</span>
            </div>
            <progress id="evidenceProgress" class="progress progress-secondary" value="50" max="100"></progress>
            <p class="text-center text-sm mt-2" id="evidenceLabel">Mixed Content</p>
          </div>
        </div>
      </div>

    </div>

    <!-- Analysis Summary -->
    <div class="card bg-base-200 shadow-xl mb-8">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-4">Analysis Summary</h2>
        <div id="summaryContent" class="prose max-w-none">
          <p>Analysis will appear here...</p>
        </div>
      </div>
    </div>

    <!-- Verified Sources -->
    <div class="card bg-base-200 shadow-xl mb-8">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-4">Verified Sources</h2>
        <div id="sourcesContent" class="grid grid-cols-1 gap-4">
          <!-- Sources will be inserted here -->
        </div>
      </div>
    </div>

    <!-- Methodology Note -->
    <div class="alert alert-info">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <div>
        <h3 class="font-bold">About This Analysis</h3>
        <div class="text-sm" id="methodologyNote">
          This analysis uses AI to evaluate factual claims through web search verification. 
          Scores reflect factuality and evidence quality, not political agreement. 
          The analysis aims to be objective and non-partisan.
        </div>
      </div>
    </div>

  </div>

</div>

<script>
// Main analysis function
async function analyzePost() {
  const postInput = document.getElementById('postInput').value.trim();
  const apiKey = document.getElementById('apiKey').value.trim();
  const provider = document.getElementById('apiProvider').value;
  
  // Validation
  if (!postInput) {
    showError('Please enter a social media post to analyze.');
    return;
  }
  
  if (!apiKey) {
    showError('Please enter your AI API key.');
    return;
  }
  
  // Show loading state
  showLoading();
  hideError();
  hideResults();
  
  try {
    const analysis = await performAnalysis(postInput, apiKey, provider);
    displayResults(analysis);
  } catch (error) {
    showError(`Analysis failed: ${error.message}`);
  } finally {
    hideLoading();
  }
}

// Perform the analysis using serverless function
async function performAnalysis(post, apiKey, provider) {
  try {
    const response = await fetch('/.netlify/functions/analyze', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        post: post,
        apiKey: apiKey,
        provider: provider
      })
    });
    
    if (!response.ok) {
      let errorMessage = `Server error: ${response.status}`;
      // Read response as text first, then try to parse as JSON
      const text = await response.text();
      try {
        const error = JSON.parse(text);
        errorMessage = error.error || errorMessage;
      } catch (e) {
        // Response wasn't JSON, might be HTML error page
        if (text.includes('<html>')) {
          errorMessage = 'Server error: The serverless function returned an error page. Check Netlify function logs for details.';
        } else if (text.length > 0) {
          errorMessage = `Server error: ${response.status} - ${text.substring(0, 100)}`;
        }
      }
      throw new Error(errorMessage);
    }
    
    return await response.json();
  } catch (error) {
    if (error.message.includes('Failed to fetch')) {
      throw new Error('Network error: Unable to connect to analysis service. Please check your internet connection.');
    }
    if (error.message.includes('JSON')) {
      throw new Error('Server error: Received invalid response from analysis service. The serverless function may not be deployed correctly.');
    }
    throw error;
  }
}

// Display results
function displayResults(analysis) {
  // Update factuality score
  const factualityProgress = document.getElementById('factualityProgress');
  const factualityValue = document.getElementById('factualityValue');
  const factualityLabel = document.getElementById('factualityLabel');
  
  factualityProgress.style.setProperty('--value', analysis.factuality_score);
  factualityValue.textContent = `${analysis.factuality_score}%`;
  
  // Set color based on score
  if (analysis.factuality_score < 34) {
    factualityProgress.classList.add('text-error');
    factualityLabel.textContent = 'Low Factual Basis';
  } else if (analysis.factuality_score < 67) {
    factualityProgress.classList.add('text-warning');
    factualityLabel.textContent = 'Moderate Factual Basis';
  } else {
    factualityProgress.classList.add('text-success');
    factualityLabel.textContent = 'High Factual Basis';
  }
  
  // Update political lean
  const politicalProgress = document.getElementById('politicalProgress');
  const politicalLabel = document.getElementById('politicalLabel');
  
  politicalProgress.value = analysis.political_lean;
  
  if (analysis.political_lean < 40) {
    politicalLabel.textContent = 'Leans Left';
  } else if (analysis.political_lean < 60) {
    politicalLabel.textContent = 'Center/Neutral';
  } else {
    politicalLabel.textContent = 'Leans Right';
  }
  
  // Update evidence type
  const evidenceProgress = document.getElementById('evidenceProgress');
  const evidenceLabel = document.getElementById('evidenceLabel');
  
  evidenceProgress.value = analysis.evidence_type;
  
  if (analysis.evidence_type < 34) {
    evidenceLabel.textContent = 'Primarily Factual';
  } else if (analysis.evidence_type < 67) {
    evidenceLabel.textContent = 'Mixed Fact/Opinion';
  } else {
    evidenceLabel.textContent = 'Primarily Opinion';
  }
  
  // Update summary
  const summaryContent = document.getElementById('summaryContent');
  summaryContent.innerHTML = `
    <div class="mb-4">
      <h3 class="font-bold text-lg mb-2">Main Finding</h3>
      <p>${analysis.summary.main}</p>
    </div>
    <div class="mb-4">
      <h3 class="font-bold text-lg mb-2">Key Findings</h3>
      <p>${analysis.summary.key_findings}</p>
    </div>
    ${analysis.summary.factual_issues ? `
    <div>
      <h3 class="font-bold text-lg mb-2">Factual Issues Identified</h3>
      <p>${analysis.summary.factual_issues}</p>
    </div>
    ` : ''}
  `;
  
  // Update sources
  const sourcesContent = document.getElementById('sourcesContent');
  sourcesContent.innerHTML = analysis.sources.map(source => `
    <div class="card bg-base-100 hover:shadow-lg transition-shadow">
      <div class="card-body">
        <div class="flex items-start gap-3">
          <div class="badge badge-${getCredibilityBadgeColor(source.credibility)} badge-lg">
            ${source.credibility.toUpperCase()}
          </div>
          <div class="flex-1">
            <h3 class="font-bold text-lg mb-2">${source.title}</h3>
            <p class="text-sm mb-2">${source.description}</p>
            <a href="${source.url}" target="_blank" rel="noopener noreferrer" class="link link-primary text-sm">
              Visit Source â†’
            </a>
          </div>
        </div>
      </div>
    </div>
  `).join('');
  
  // Update methodology note
  document.getElementById('methodologyNote').textContent = analysis.methodology_note;
  
  // Show results
  showResults();
}

// Helper function for credibility badge colors
function getCredibilityBadgeColor(credibility) {
  const colors = {
    high: 'success',
    medium: 'warning',
    low: 'error'
  };
  return colors[credibility.toLowerCase()] || 'neutral';
}

// UI state management
function showLoading() {
  document.getElementById('loadingState').classList.remove('hidden');
}

function hideLoading() {
  document.getElementById('loadingState').classList.add('hidden');
}

function showError(message) {
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('errorState').classList.remove('hidden');
}

function hideError() {
  document.getElementById('errorState').classList.add('hidden');
}

function showResults() {
  document.getElementById('resultsSection').classList.remove('hidden');
}

function hideResults() {
  document.getElementById('resultsSection').classList.add('hidden');
}

// Allow Enter key in textarea for better UX
document.getElementById('postInput')?.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && e.ctrlKey) {
    analyzePost();
  }
});
</script>

<style>
/* Custom styles for better visual hierarchy */
.radial-progress {
  --value: 0;
  --size: 12rem;
  --thickness: 1rem;
}

.prose {
  max-width: 100%;
}

/* Smooth transitions */
.card {
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
}

/* Ensure progress bars have good visibility */
.progress {
  height: 1rem;
}
</style>
{{ end }}
